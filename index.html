<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zone Marker (Safe Mode)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 100%; }
    .sidebar {
      position: absolute; top: 10px; left: 10px;
      background: white; padding: 10px; border-radius: 5px;
      z-index: 1000; max-height: 90%; overflow-y: auto;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }
    .zone-item { margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
    .search-bar {
      position: absolute; top: 10px; right: 10px; z-index: 1000;
      background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }

    /* ‚úÖ Move draw tools down and right */
    .leaflet-top.leaflet-left {
      top: 180px !important;
      left: 10px !important;
      z-index: 1001;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div class="sidebar">
  <h3>Zones</h3>
  <div id="zoneList"></div>
  <button onclick="exportZones()">üìÑ Export CSV</button>
</div>
<div class="search-bar">
  <input type="text" id="searchInput" placeholder="Search area (e.g. Hydra)" />
  <button onclick="searchPlace()">üîç</button>
</div>

<!-- Leaflet and Drawing Plugins -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  // üîß Replace this with your Firebase project config:
  const firebaseConfig = {
    apiKey: "AIzaSyBx_OnE3Eju46i2LCHDAUBg-Y-ZupdKIf8",
    authDomain: "zonemarkerapp.firebaseapp.com",
    projectId: "zonemarkerapp",
    storageBucket: "zonemarkerapp.firebasestorage.app",
    messagingSenderId: "613702079615",
    appId: "1:613702079615:web:8c99d82debc2a1897fdb4a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let map = L.map('map').setView([36.7538, 3.0588], 12); // Algeria default
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  const drawControl = new L.Control.Draw({
    draw: { polyline: false, marker: false, circle: false, rectangle: false, circlemarker: false },
    edit: { featureGroup: drawnItems }
  });
  map.addControl(drawControl);

  function loadZones() {
    drawnItems.clearLayers();
    document.getElementById("zoneList").innerHTML = "";

    db.collection("zones").get().then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        const polygon = L.polygon(data.path, {
          color: getZoneColor(data.status),
          fillOpacity: 0.5
        }).addTo(drawnItems);

        polygon.bindPopup(`<b>${data.name}</b><br>Status: ${data.status}<br>Notes: ${data.notes}`);
        addZoneToList(doc.id, data);
      });
    });
  }

  function addZoneToList(id, data) {
    const div = document.createElement("div");
    div.className = "zone-item";
    div.innerHTML = `
      <strong>${data.name}</strong><br>
      Status: ${data.status}<br>
      Notes: ${data.notes}<br>
      <button onclick="deleteZone('${id}')">üóëÔ∏è Delete</button>
    `;
    document.getElementById("zoneList").appendChild(div);
  }

  function deleteZone(id) {
    db.collection("zones").doc(id).delete().then(loadZones);
  }

  function getZoneColor(status) {
    switch (status.toLowerCase()) {
      case "completed": return "green";
      case "pending": return "orange";
      case "not reached": return "red";
      default: return "gray";
    }
  }

  map.on(L.Draw.Event.CREATED, function (e) {
    const layer = e.layer;
    const path = layer.getLatLngs()[0].map(coord => ({ lat: coord.lat, lng: coord.lng }));
    const name = prompt("Zone Name:");
    if (!name) return;
    const status = prompt("Status (Completed, Pending, Not Reached):");
    const notes = prompt("Notes (optional):");

    db.collection("zones").add({
      name, status: status.toLowerCase(), notes, path
    }).then(loadZones);
  });

  function exportZones() {
    db.collection("zones").get().then(snapshot => {
      let csv = "Name,Status,Notes,Coordinates\n";
      snapshot.forEach(doc => {
        const d = doc.data();
        const coords = d.path.map(p => `(${p.lat},${p.lng})`).join(" ");
        csv += `"${d.name}","${d.status}","${d.notes}","${coords}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "zones.csv";
      a.click();
      URL.revokeObjectURL(url);
    });
  }

  function searchPlace() {
    const query = document.getElementById("searchInput").value;
    if (!query) return;
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        if (data.length > 0) {
          const place = data[0];
          map.setView([place.lat, place.lon], 14);
        } else {
          alert("Place not found.");
        }
      });
  }

  loadZones();
</script>

</body>
</html>
