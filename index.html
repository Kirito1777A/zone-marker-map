<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zone Marker App with Categories</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; }
    .controls { position: absolute; top: 10px; left: 10px; background: white; padding: 10px; z-index: 1000; border-radius: 8px; }
    .panel { position: absolute; top: 100px; left: 10px; width: 300px; background: white; max-height: 80%; overflow-y: auto; padding: 10px; z-index: 1000; border-radius: 8px; }
    .category-section { margin-bottom: 10px; }
    .category-title { font-weight: bold; cursor: pointer; }
    .item { margin-left: 10px; margin-top: 5px; }
    button { margin-top: 5px; }
  </style>
</head>
<body>
<div id="map"></div>
<div class="controls">
  <input id="categoryInput" placeholder="New Category" />
  <button onclick="addCategory()">Add Category</button><br><br>
  <select id="categorySelect"></select>
  <button onclick="activateAddStore()">Add Store</button>
</div>
<div class="panel" id="storePanel"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBx_OnE3Eju46i2LCHDAUBg-Y-ZupdKIf8",
    authDomain: "zonemarkerapp.firebaseapp.com",
    projectId: "zonemarkerapp",
    storageBucket: "zonemarkerapp.firebasestorage.app",
    messagingSenderId: "613702079615",
    appId: "1:613702079615:web:8c99d82debc2a1897fdb4a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let map = L.map('map').setView([36.75, 3.05], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  let addStoreMode = false;
  let storeTemp = {};
  let categories = [];

  function addCategory() {
    const name = document.getElementById('categoryInput').value.trim();
    if (!name || categories.includes(name)) return;
    categories.push(name);
    updateCategorySelect();
    document.getElementById('categoryInput').value = '';
    renderStores();
  }

  function updateCategorySelect() {
    const select = document.getElementById('categorySelect');
    select.innerHTML = '';
    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      select.appendChild(opt);
    });
  }

  function activateAddStore() {
    addStoreMode = true;
  }

  map.on('click', function(e) {
    if (!addStoreMode) return;
    addStoreMode = false;
    const name = prompt('Store name:');
    const notes = prompt('Notes:');
    const category = document.getElementById('categorySelect').value;
    if (!name || !category) return;

    const store = {
      name,
      notes: notes || '',
      category,
      lat: e.latlng.lat,
      lng: e.latlng.lng
    };
    db.collection('stores').add(store).then(loadStores);
  });

  function loadStores() {
    db.collection('stores').get().then(snapshot => {
      window.stores = {};
      snapshot.forEach(doc => {
        const data = doc.data();
        window.stores[doc.id] = data;
      });
      renderStores();
    });
  }

  function renderStores() {
    const panel = document.getElementById('storePanel');
    panel.innerHTML = '';
    categories.forEach(cat => {
      const section = document.createElement('div');
      section.className = 'category-section';

      const title = document.createElement('div');
      title.className = 'category-title';
      title.textContent = cat;
      section.appendChild(title);

      for (let id in window.stores) {
        const store = window.stores[id];
        if (store.category === cat) {
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `${store.name} (${store.lat.toFixed(3)}, ${store.lng.toFixed(3)})<br>${store.notes}<br>`;
          const btn = document.createElement('button');
          btn.textContent = '✏️ Edit';
          btn.onclick = () => editStore(id);
          div.appendChild(btn);
          section.appendChild(div);
        }
      }
      panel.appendChild(section);
    });
  }

  function editStore(id) {
    const store = window.stores[id];
    const newName = prompt('Store name:', store.name);
    const newNotes = prompt('Notes:', store.notes);
    const newCat = prompt('Category:', store.category);
    if (!newName || !newCat) return;
    db.collection('stores').doc(id).update({
      name: newName,
      notes: newNotes || '',
      category: newCat
    }).then(loadStores);
  }

  loadStores();
</script>
</body>
</html>
