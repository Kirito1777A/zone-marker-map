<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Zone Marker (Safe Mode)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 100%; }

    .sidebar {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      z-index: 1000;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      width: 260px;
    }

    .zone-item {
      margin-bottom: 12px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 8px;
    }

    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.15);
      width: 260px;
    }

    .controls input, .controls button {
      width: 100%;
      margin-top: 6px;
      padding: 8px;
      font-size: 14px;
    }

    .status-popup {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .status-popup-inner {
      background: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .status-popup-inner button {
      margin: 8px;
      padding: 10px 20px;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .status-completed { background-color: #4caf50; color: white; }
    .status-pending { background-color: #ff9800; color: white; }
    .status-notreached { background-color: #f44336; color: white; }

    .leaflet-top.leaflet-left {
      top: 180px !important;
      left: 10px !important;
      z-index: 1001;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="sidebar">
  <h3>üìç Zones</h3>
  <div id="zoneList"></div>
  <button onclick="exportZones()">üìÑ Export CSV</button>
</div>

<div class="controls">
  <input type="text" id="searchInput" placeholder="Search area (e.g. Hydra)" />
  <button onclick="searchPlace()">üîç Search</button>
  <p style="margin-top: 15px;"><strong>Draw a zone</strong> using the tool on the map.</p>
</div>

<div id="statusPopup" class="status-popup" style="display:none;">
  <div class="status-popup-inner">
    <h3>Select Status</h3>
    <button class="status-completed" onclick="selectStatus('Completed')">‚úÖ Completed</button>
    <button class="status-pending" onclick="selectStatus('Pending')">üïì Pending</button>
    <button class="status-notreached" onclick="selectStatus('Not Reached')">‚ùå Not Reached</button>
  </div>
</div>

<!-- Leaflet and Drawing Plugins -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBx_OnE3Eju46i2LCHDAUBg-Y-ZupdKIf8",
    authDomain: "zonemarkerapp.firebaseapp.com",
    projectId: "zonemarkerapp",
    storageBucket: "zonemarkerapp.firebasestorage.app",
    messagingSenderId: "613702079615",
    appId: "1:613702079615:web:8c99d82debc2a1897fdb4a"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let map = L.map('map').setView([36.7538, 3.0588], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

  const drawControl = new L.Control.Draw({
    draw: { polyline: false, marker: false, circle: false, rectangle: false, circlemarker: false },
    edit: { featureGroup: drawnItems }
  });
  map.addControl(drawControl);

  let newZoneLayer = null;
  let newZoneName = "";
  let newZoneNotes = "";

  function loadZones() {
    drawnItems.clearLayers();
    document.getElementById("zoneList").innerHTML = "";

    db.collection("zones").get().then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        const polygon = L.polygon(data.path, {
          color: getZoneColor(data.status),
          fillOpacity: 0.5
        }).addTo(drawnItems);

        polygon.bindPopup(`<b>${data.name}</b><br>Status: ${data.status}<br>Notes: ${data.notes}`);
        addZoneToList(doc.id, data);
      });
    });
  }

  function addZoneToList(id, data) {
    const div = document.createElement("div");
    div.className = "zone-item";
    div.innerHTML = `
      <strong>${data.name}</strong><br>
      Status: ${data.status}<br>
      Notes: ${data.notes}<br>
      <button onclick="deleteZone('${id}')">üóëÔ∏è Delete</button>
    `;
    document.getElementById("zoneList").appendChild(div);
  }

  function deleteZone(id) {
    db.collection("zones").doc(id).delete().then(loadZones);
  }

  function getZoneColor(status) {
    switch (status.toLowerCase()) {
      case "completed": return "#4caf50";
      case "pending": return "#ff9800";
      case "not reached": return "#f44336";
      default: return "gray";
    }
  }

  map.on(L.Draw.Event.CREATED, function (e) {
    newZoneLayer = e.layer;
    const name = prompt("Zone Name:");
    if (!name) return;
    const notes = prompt("Notes (optional):");
    newZoneName = name;
    newZoneNotes = notes || "";
    document.getElementById("statusPopup").style.display = "flex";
  });

  function selectStatus(status) {
    const path = newZoneLayer.getLatLngs()[0].map(coord => ({
      lat: coord.lat,
      lng: coord.lng
    }));

    db.collection("zones").add({
      name: newZoneName,
      notes: newZoneNotes,
      status: status.toLowerCase(),
      path
    }).then(() => {
      document.getElementById("statusPopup").style.display = "none";
      loadZones();
    });
  }

  function exportZones() {
    db.collection("zones").get().then(snapshot => {
      let csv = "Name,Status,Notes,Coordinates\n";
      snapshot.forEach(doc => {
        const d = doc.data();
        const coords = d.path.map(p => `(${p.lat},${p.lng})`).join(" ");
        csv += `"${d.name}","${d.status}","${d.notes}","${coords}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "zones.csv";
      a.click();
      URL.revokeObjectURL(url);
    });
  }

  function searchPlace() {
    const query = document.getElementById("searchInput").value;
    if (!query) return;
    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        if (data.length > 0) {
          const place = data[0];
          map.setView([place.lat, place.lon], 14);
        } else {
          alert("Place not found.");
        }
      });
  }

  loadZones();
</script>

</body>
</html>
